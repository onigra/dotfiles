---
description: PRコードレビュー用ルール - gh pr diff の出力をレビューする際に使用
globs:
alwaysApply: false
---

# コードレビュールール

このルールは、GitHub PRの差分をレビューする際に適用されます。

## 使用方法

1. Cursorのチャットで `@code-review` を入力してこのルールを有効化
2. 以下のいずれかの方法でPR差分を渡す:
   - `gh pr diff <PR番号> をレビューして` と入力
   - PR差分をコピー＆ペーストして「レビューして」と依頼

## レビュー観点

### 1. セキュリティ (Critical)
- **SQLインジェクション**: 生のSQLクエリ、`DB::raw()`の不適切な使用
- **XSS**: エスケープされていないユーザー入力の出力
- **認証・認可**: 適切なミドルウェア適用、権限チェックの漏れ
- **機密情報の露出**: パスワード、APIキー、トークンのハードコーディング

### 2. パフォーマンス (Warning)
- **N+1クエリ**: Eager Loading の欠如
- **不要なクエリ**: ループ内でのDBアクセス
- **インデックス**: 検索条件に使用されるカラムのインデックス考慮
- **キャッシュ**: 頻繁にアクセスされるデータのキャッシュ戦略

### 4. コード品質 (Info/Warning)
- **単一責任の原則**: クラス・メソッドが1つの責務に集中しているか
- **重複コード**: DRY原則の遵守
- **マジックナンバー/文字列**: 定数化の検討
- **型宣言**: 引数・戻り値の型宣言
- **ドキュメントの整合性**: ドキュメントと実装の一致

### 5. エラーハンドリング (Warning)
- **例外処理**: 適切なtry-catch、カスタム例外の使用
- **バリデーション**: 適切なルール設定
- **ログ出力**: エラー時の適切なログ記録

### 6. テスト (Info)
- **テストの有無**: 新機能・バグ修正に対応するテストの存在
- **テストカバレッジ**: 重要なパスのカバー
- **テストの品質**: 意味のあるアサーション

## 出力フォーマット

レビュー結果は以下の形式で出力してください:

### Cursorチャット用出力

```
## レビュー結果サマリー

- Critical: X件
- Warning: Y件
- Info: Z件

---

### [Critical] セキュリティ: SQLインジェクションの可能性
**ファイル**: `app/dir/file` (L23-25)

**問題**:
```php
// 問題のあるコード
```

**修正案**:
```php
// 修正後のコード
```

---

### [Warning] パフォーマンス: N+1クエリの可能性
...
```

### GitHub PR投稿用出力

レビュー結果をGitHub PRに投稿する場合は、以下のコマンドを提示してください:

```bash
gh pr review <PR番号> --comment --body "## コードレビュー結果

<レビュー内容をMarkdown形式で>
"
```

または、Approveする場合:
```bash
gh pr review <PR番号> --approve --body "LGTM! 🎉

<コメントがあれば>
"
```

修正を求める場合:
```bash
gh pr review <PR番号> --request-changes --body "## 修正をお願いします

<修正が必要な点>
"
```

## レビュー開始

PR差分を受け取ったら、上記の観点に基づいてレビューを行い、結果を出力してください。
問題がない場合は「LGTM」と伝え、GitHub投稿用のApproveコマンドを提示してください。
